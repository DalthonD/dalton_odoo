,coalesce(po.ticket_number,cast(left(po.pos_reference,16) as Integer)) as factura

select date(po.date_order) as fecha
        ,po.location_id as sucursal
        ,coalesce(po.ticket_number,cast(right(po.pos_reference,4) as Integer)) as factura
        ,/*Calculando el gravado (todo lo que tiene un impuesto aplicado de iva)*/
        case when afp.sv_clase='Gravado' then 
	(case when ((po.amount_tax < 0) or (po.amount_total < 0)) = TRUE then
	po.amount_total
        else po.amount_total - po.amount_tax end) 
	else 0.00 end as Gravado
        ,/*Calculando el excento que no tiene iva*/
        case when afp.sv_clase='Exento' then
	po.amount_total
	else 0.00 end as Exento
        ,/*Calculando el iva*/
        case when afp.sv_clase='Gravado' then
        po.amount_tax 
        else 0.00 end as Iva
        ,/*Calculando el retenido*/
        (0.00) as Retenido
	,afp.id
	,afp.sv_clase
        from pos_order po inner join account_fiscal_position afp on po.fiscal_position_id=afp.id
        where po.company_id= 1
	--and afp.sv_clase='Gravado'
        and date_part('year',COALESCE(po.create_date,po.date_order))= 2019
        and date_part('month',COALESCE(po.create_date,po.date_order))=  6
        and po.invoice_id is null
        and po.state in ('done','paid');

case when po.amount_tax < 0 and po.amount_total >= 0 then
	po.amount_total
else po.amount_total - po.amount_tax end as Gravado







Select
        SS.Fecha
        ,SS.sucursal
        ,min(SS.factura) as DELNum
        ,max(SS.factura) as ALNum
        ,sum(SS.Exento) as Exento
        ,sum(SS.GravadoLocal) as GravadoLocal
        ,sum(0.00) as GravadoExportacion
        ,Sum(SS.ivaLocal) as IvaLocal
        ,Sum(0.00) as IvaExportacion
        ,Sum(0.00) as Retenido
        FROM(select S.fecha
        ,S.sucursal
        ,S.factura
        ,S.exento
        ,S.Gravado as GravadoLocal
        ,0.00 as GravadoExportacion
        ,S.Iva as IvaLocal
        ,0.00 as IvaExportacion
        ,S.Retenido
        from(
        select date(po.date_order) as fecha
        ,po.location_id as sucursal
        ,coalesce(po.ticket_number,cast(right(po.pos_reference,4) as Integer)) as factura
        ,/*Calculando el gravado (todo lo que tiene un impuesto aplicado de iva)*/
        case when afp.sv_clase='Gravado' then
	       (case when ((po.amount_tax < 0) or (po.amount_total < 0)) = TRUE then
	        po.amount_total
            else po.amount_total - po.amount_tax end)
	    else 0.00 end as Gravado
        ,/*Calculando el excento que no tiene iva*/
        case when afp.sv_clase='Exento' then
	       po.amount_total
	    else 0.00 end as Exento
        ,/*Calculando el iva*/
        case when afp.sv_clase='Gravado' then
        po.amount_tax
        else 0.00 end as Iva
        ,/*Calculando el retenido*/
        (0.00) as Retenido
        from pos_order po inner join account_fiscal_position afp on po.fiscal_position_id=afp.id
        where po.company_id= 1
        and date_part('year',COALESCE(po.create_date,po.date_order))= 2019
        and date_part('month',COALESCE(po.create_date,po.date_order))=  6
        and po.invoice_id is null
        and po.state in ('done','paid')
        )S)SS group by SS.fecha, SS.sucursal order by SS.fecha,SS.sucursal;




/home/odoo/src/odoo/odoo/addons/base/models/res_users.py


